#!/usr/bin/env bash
set -euo pipefail

. .demo-env || true

echo "Next, the smiley-face team needs to create a governance system (SNS) that implements those decisions."
SNS_WASM_CANISTER_ID="$(dfx canister --network "$DFX_NETWORK" id nns-sns-wasm 2>/dev/null)"
read -rp "sns deploy"
  set -- --init-config-file sns_init.yml
  : We actually run with some flags to point at the testnet.
  sns deploy --network "$DFX_NETWORK" --override-sns-wasm-canister-id-for-tests "${SNS_WASM_CANISTER_ID}" "${@}" |
    tee /dev/stderr >sns_creation.idl

  echo "Populate canister_ids.json"
  if test -e canister_ids.json; then
    EXISTING_CANISTER_IDS="canister_ids.$(date -Iseconds)"
    cp canister_ids.json "$EXISTING_CANISTER_IDS"
  else
    echo "{}" >canister_ids.json
  fi
  sed -n ':a;/^[(]/bb;d;ba;:b;p;n;bb' <sns_creation.idl |
    idl2json |
    jq '.canisters[] | to_entries | map({ ("sns_"+.key): {(env.DFX_NETWORK): (.value[0])} }) | add' |
    jq -s '.[0] * .[1]' - canister_ids.json >canister_ids.json.new
  mv canister_ids.json.new canister_ids.json
echo
