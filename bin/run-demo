set -euo pipefail

test -f canister_ids.json || echo '{}' > canister_ids.json

echo "Checking that we have a network..."
while test -z "${DFX_NETWORK:-}"; do
	read -rp "Which network would you like to use?  " DFX_NETWORK
done
export DFX_NETWORK


echo "Checking that we have an nns-dapp dir..."
while true ; do
test -e "${ND_DIR:-}/dfx.json" && break || {
  read -rp "Where is the nns-repo?  " ND_DIR
}
done


echo "Checking that we have network config"
jq -e '.networks[env.DFX_NETWORK]' dfx.json || {
  jq -s '.[0] * .[1]' dfx.json <( cd "$ND_DIR" ; jq '{networks: .networks}' dfx.json ) > dfx.json.new && mv dfx.json.new dfx.json
}

echo "Creating identities..."
/home/max/dfn/nns-dapp/branches/sns-demo-materials/e2e-tests/scripts/create-dfx-identites.sh
for ((i=1; i<5; i++)) ; do
  dfx --identity "ident-$i" wallet --network $DFX_NETWORK balance
done



echo "Getting cycles for ident-1"
dfx identity use ident-1
export WALLET_CANISTER="$(dfx identity --network $DFX_NETWORK get-wallet)"
dfx wallet --network $DFX_NETWORK balance
: TODO: check cycles and loop if needed.


echo "Deploying dapp"
dfx canister --network "$DFX_NETWORK" call smiley_dapp getBackgroundColor '()' || {
  npm ci
  dfx deploy --network $DFX_NETWORK --with-cycles 1000000000000 smiley_dapp 
  dfx deploy --network $DFX_NETWORK --with-cycles 1000000000000 smiley_dapp_assets
}

echo "Getting dapp info..."
export DAPP_NAME=smiley_dapp_assets
echo "See: $(jq -r '.networks[env.DFX_NETWORK].config.HOST' dfx.json | awk -F '://' -v canister_id="$(jq -r .[env.DAPP_NAME][env.DFX_NETWORK] canister_ids.json)" '{print $1 FS canister_id "." $2}')"
read -rp "Press enter to continue... "
DAPP_FRONTEND="$(jq -r .smiley_dapp_assets[env.DFX_NETWORK] canister_ids.json)"
DAPP_BACKEND="$(jq -r .smiley_dapp[env.DFX_NETWORK] canister_ids.json)"
export DAPP_FRONTEND
export DAPP_BACKEND

echo "Querying the canister:"
set dfx canister --network "$DFX_NETWORK" call smiley_dapp getBackgroundColor '()'
echo "  ${*}"
"${@}"
read -rp "Press enter to continue... "


echo "Adding the sns-wasm and did files to dfx.json"
/home/max/dfn/ic-gitlab/rs/sns/cli/import-dfx /home/max/dfn/ic-gitlab/rs/sns/cli
/home/max/dfn/ic-gitlab/rs/sns/cli/import-dfx /home/max/dfn/ic-gitlab/rs/nns
echo "Checking that we have an SNS..."
while test -z "${SNS_WASM:-}"; do
  SNS_WASM="$(jq -r '.["sns-wasm"][env.DFX_NETWORK]' canister_ids.json)"
  test -z "${SNS_WASM:-}" || break
  echo
  echo "Please populate canister_ids.json with the sns-wasm ID."
  read -rp "Press enter to continue... "
  echo
done

echo "Current list of SNSs:"
dfx canister --network $DFX_NETWORK call sns-wasm list_deployed_snses '(record {} )'
read -rp "Press enter to continue... "

echo "See SNS's in the frontend dapp:"
(
  cd "$ND_DIR"
  export DAPP_NAME=nns-dapp
  url="$(jq -r '.networks[env.DFX_NETWORK].config.HOST' dfx.json | awk -F '://' -v canister_id="$(jq -r .[env.DAPP_NAME][env.DFX_NETWORK] canister_ids.json)" '{print $1 FS canister_id "." $2}')"
  echo "See: ${url}/#/launchpad"
  read -rp "Press enter to continue... "
)

echo "Install quill"
command -v sns-quill ||
(
    git clone git@github.com:dfinity/sns-quill.git
    cd sns-quill
    make release
    install /home/max/dfn/snsdemo/sns-quill/target/release/sns-quill "$HOME/.local/bin/"
)

echo "Set the sns-quill network URL..."
export IC_URL="$(jq -r '.networks[env.DFX_NETWORK].providers[0]' dfx.json)"

echo -e "\nGetting front end neuron IDs..."
(
  export DAPP_NAME=nns-dapp
  url="$(jq -r '.networks[env.DFX_NETWORK].config.HOST' dfx.json | awk -F '://' -v canister_id="$(jq -r .[env.DAPP_NAME][env.DFX_NETWORK] canister_ids.json)" '{print $1 FS canister_id "." $2}')"
  echo "nns-dapp url: ${url}/#/neurons"
)
while test -z "${NNS_MAJORITY_NEURON:-}" ; do
  echo "Please stake 900 ICP in the nns-dapp, as user 10000, with a dissolve delay of 8 years."
  read -rp "Please enter the neuron principal: " NNS_MAJORITY_NEURON
  echo "Thank you.  This neuron represents the public voting majority on the IC."
done
echo

while test -z "${DEVELOPER_NEURON:-}" ; do
  echo "Please stake 10 ICP in the nns-dapp, as user 10001, with a dissolve delay of 8 years."
  read -rp "Please enter the neuron principal: " DEVELOPER_NEURON
  echo "Please add a hotkey for the developer principal: " $(dfx --identity ident-1 identity get-principal)
  read -rp "Please press enter to continue... "
  echo "Thank you.  This neuron enables the developer to make proposals."
done
echo


for magic in cf36661f8287be559ffccd4876617f953d76f1bb1c34e83229b0caaf713557b4 14ad11c9263b2977bd8d186956a2fa136a2614e7364bbae9fdc076e87b702b6e
do
  read -rp "Please send 10 ICP to $magic (Press enter when done) "
done


#for DFX_ID in ident-3 ident-4 ; do
#  (
#    export DFX_ID
#    WALLET_ADDRESS="$(jq -r '.identities[env.DFX_ID][env.DFX_NETWORK]' "${HOME}/.config/dfx/identity/$DFX_ID/wallets.json")"
#    read -rp "Please send 10 ICP to ${DFX_ID} at ${WALLET_ADDRESS} (Press enter when done) "
#  )
#done

clear
read -rp "Ready to start the demo.  Pless enter to proceed... "
clear

echo "First, the smiley-face team needs to decide on parameters for the decentralisation."
echo "We will use a pre-populated configuration..."
: TODO - create a configuration
: TODO - prompt the user for key details
read -rp "Press enter to have a look... "
$EDITOR sns_init.yml
echo

echo "Next, the smiley-face team needs to create a governance system (SNS) that implements those decisions."
SNS_WASM_CANISTER_ID="$(dfx canister --network "$DFX_NETWORK" id sns-wasm 2>/dev/null)"
read -rp "Press enter to continue... "
  echo "Creating SNS"
  set -- --init-config-file sns_init.yml
  echo sns "${@}"
  : We actually run with some flags to point at the testnet.
  sns deploy --network "$DFX_NETWORK" --override-sns-wasm-canister-id-for-tests "${SNS_WASM_CANISTER_ID}" "${@}" |
    tee /dev/stderr >sns_creation.idl

  echo "Populate canister_ids.json"
  if test -e canister_ids.json; then
    EXISTING_CANISTER_IDS="canister_ids.$(date -Iseconds)"
    cp canister_ids.json "$EXISTING_CANISTER_IDS"
  else
    echo "{}" >canister_ids.json
  fi
  sed -n ':a;/^[(]/bb;d;ba;:b;p;n;bb' <sns_creation.idl |
    idl2json |
    jq '.canisters[] | to_entries | map({ ("sns_"+.key): {(env.DFX_NETWORK): (.value[0])} }) | add' |
    jq -s '.[0] * .[1]' - canister_ids.json >canister_ids.json.new
  mv canister_ids.json.new canister_ids.json
echo


echo "The SNS should be listed:"
dfx canister --network $DFX_NETWORK call sns-wasm list_deployed_snses '(record {} )'
read -rp "Press enter to continue... "
echo

echo "The neurons from the configuration file are listed:"
set dfx canister --network $DFX_NETWORK call sns_governance list_neurons '(record { of_principal=null; limit=100: nat32; start_page_at=null  } )'
echo "${@}"
"${@}"
read -rp "Press enter to continue... "
echo

echo "If we examine the SNS we see management canisters but no dapps:"
dfx canister --network $DFX_NETWORK call sns_root list_sns_canisters '(record {} )'
read -rp "Press enter to continue... "
echo

echo "We hand over ownership of the canisters to the SNS:"
(
set -eux
SNS_ROOT="$(jq -r .sns_root[env.DFX_NETWORK] canister_ids.json)"
DAPP_FRONTEND="$(jq -r .smiley_dapp_assets[env.DFX_NETWORK] canister_ids.json)"
DAPP_BACKEND="$(jq -r .smiley_dapp[env.DFX_NETWORK] canister_ids.json)"
for CANISTER in "$DAPP_FRONTEND" "$DAPP_BACKEND" ; do
        dfx canister --network $DFX_NETWORK status $CANISTER
        dfx canister --network $DFX_NETWORK update-settings $CANISTER --add-controller $SNS_ROOT
        dfx canister --network $DFX_NETWORK update-settings $CANISTER --remove-controller $WALLET_CANISTER
        dfx canister --network $DFX_NETWORK update-settings $CANISTER --remove-controller $PRINCIPAL
        dfx canister --network $DFX_NETWORK call sns_root register_dapp_canister "(record {canister_id = opt principal \"${CANISTER}\" } )"
done
set +x
)
dfx canister --network $DFX_NETWORK call sns_root list_sns_canisters '(record {} )'
read -rp "Press enter to continue... "
echo
